<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>PixiJS 8 - SharedArrayBuffer with 4 Workers (SoA + Spatial)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
            font-family: monospace;
        }

        canvas {
            display: block;
            width: 800px;
            height: 600px;
            border: 1px solid #333;
        }

        p {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            margin: 5px 10px;
        }

        #config {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }

        #spatialFPS {
            color: #a29bfe;
        }

        #logicFPS {
            color: #ff6b6b;
        }

        #physicsFPS {
            color: #4ecdc4;
        }

        #renderFPS {
            color: #ffe66d;
        }

        #visibleUnits {
            color: #95e1d3;
        }
    </style>
</head>
<body>
    <p id="config">Mode: SHARED ARRAY BUFFER (4 Workers) - Structure of Arrays + Spatial Hash</p>
    <p id="spatialFPS">Spatial Worker FPS: --</p>
    <p id="logicFPS">Logic Worker FPS: --</p>
    <p id="physicsFPS">Physics Worker FPS: --</p>
    <p id="rendererFPS">Renderer Worker FPS: --</p>
    <p id="numberBoids">Number of entities: --</p>
    <p id="visibleUnits">Visible units: --</p>
    <p id="activeUnits">Active units: --</p>
    <p id="poolStats" style="color: #95e1d3;">Pool Stats: --</p>
    <p id="mousePos" style="color: #999; font-size: 12px;">Mouse: --</p>
    <p>Move camera with WASD or Arrow Keys, mousewheel to zoom in and out</p>

    <div style="padding: 10px 0;">
        <button onclick="gameEngine.pause()">‚è∏Ô∏è Pause</button>
        <button onclick="gameEngine.resume()">‚ñ∂Ô∏è Resume</button>
        <button onclick="spawnRandomPrey()">‚ûï Spawn Prey</button>
        <button onclick="spawnRandomPredator()">‚ûï Spawn Predator</button>
        <button onclick="spawnPreyAtMouse()">üéØ Spawn Prey at Mouse</button>
        <button onclick="spawnPredatorAtMouse()">üéØ Spawn Predator at Mouse</button>
        <button onclick="clearAllEntities()" style="background: #ff6b6b;">üóëÔ∏è Clear All</button>
    </div>

    <script src="/lib/gameObject.js"></script>
    <script src="/lib/RenderableGameObject.js"></script>
    <script src="/lib/gameEngine.js"></script>

    <script src="/predators/boid.js"></script>
    <script src="/predators/prey.js"></script>
    <script src="/predators/predator.js"></script>
    <script>
        // Initialize with GameEngine using class registration system
        const gameEngine = new GameEngine(
            {
                canvasWidth: 800,
                canvasHeight: 600,
                worldWidth: 3000,
                worldHeight: 1500,

                // Spatial hash grid configuration
                spatial: {
                    cellSize: 50,        // Each cell size in world units
                    maxNeighbors: 100,   // Maximum neighbors to track per entity
                    noLimitFPS: false    // If true, runs as fast as possible instead of 60fps
                },

                // Logic configuration
                logic: {
                    noLimitFPS: false    // If true, runs as fast as possible instead of 60fps
                },

                // Physics configuration
                physics: {
                    mode: "verlet",
                    subStepCount: 4,
                    noLimitFPS: false,   // If true, runs as fast as possible instead of 60fps

                    // Collision Detection
                    maxCollisionPairs: 80000, // Maximum collision pairs per frame

                    // Simple Separation (boid-style push, no velocity change)
                    applySeparation: true,      // Enable simple position-only separation
                    separationStrength: 0.5,    // How strong the push-apart force is (0.0 to 1.0)

                    // Full Physics Resolution (velocity + position, with bounce)
                    resolveCollisions: false,          // Enable complex physics collision resolution
                    collisionRestitution: 0.5,         // Bounciness (0=no bounce, 1=perfect bounce)
                    collisionPositionCorrection: 0.4,  // How strongly to push overlapping objects apart (0.0 to 1.0)
                    collisionFriction: 0.05,           // Friction during collisions (0.0 to 1.0)

                    // Global Forces
                    gravity: { x: 0, y: 0 }     // Global gravity applied to all entities
                }
            },
            {
                // Simple textures (for background, etc.)
                bg: "/predators/img/fondo.jpg",
                bunny: "/predators/img/bunny.png",

                // Spritesheets configuration
                spritesheets: {
                    person: {
                        json: "/predators/img/person.json",
                        png: "/predators/img/person.png"
                    },
                    personaje: {
                        json: "/predators/img/personaje.json",
                        png: "/predators/img/personaje.png"
                    }
                }
            }
        );




        // Register entity classes with their script paths
        // This is where you define what entities exist and how many
        // The script paths allow workers to dynamically load game-specific code
        // Note: Paths are relative to lib/ folder where workers are located

        // Register base classes that workers need to load (must be before child classes)
        gameEngine.registerEntityClass(Boid, 0, "../predators/boid.js");  // Base boid entities

        // Register actual game entities
        gameEngine.registerEntityClass(Prey, 5000, "../predators/prey.js");
        gameEngine.registerEntityClass(Predator, 100, "../predators/predator.js");




        // Spawning functions
        function spawnRandomPrey() {
            gameEngine.spawnEntity('Prey', {
                x: Math.random() * gameEngine.config.worldWidth,
                y: Math.random() * gameEngine.config.worldHeight,
                vx: 0,
                vy: 0
            });
        }

        function spawnRandomPredator() {
            gameEngine.spawnEntity('Predator', {
                x: Math.random() * gameEngine.config.worldWidth,
                y: Math.random() * gameEngine.config.worldHeight,
                vx: 0,
                vy: 0
            });
        }

        function spawnPreyAtMouse() {
            if (gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Prey', {
                    x: gameEngine.mouse.x,
                    y: gameEngine.mouse.y,
                    vx: 0,
                    vy: 0
                });
            }
        }

        function spawnPredatorAtMouse() {
            if (gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Predator', {
                    x: gameEngine.mouse.x,
                    y: gameEngine.mouse.y,
                    vx: 0,
                    vy: 0
                });
            }
        }

        function clearAllEntities() {
            if (confirm('Clear all entities?')) {
                gameEngine.workers.logic.postMessage({ msg: 'clearAll' });
            }
        }

        // Update pool stats periodically
        setInterval(() => {
            const poolStatsEl = document.getElementById('poolStats');
            if (poolStatsEl) {
                const boidStats = gameEngine.getPoolStats(Boid);
                const preyStats = gameEngine.getPoolStats(Prey);
                const predStats = gameEngine.getPoolStats(Predator);

                poolStatsEl.textContent = `Pool: Boid ${boidStats.active}/${boidStats.total} | Prey ${preyStats.active}/${preyStats.total} | Predator ${predStats.active}/${predStats.total}`;
            }
        }, 500);

        // Initialize and start
        gameEngine.init().catch(error => {
            document.body.innerHTML = `
                <div style="color: white; padding: 20px;">
                    <h1>Error initializing game!</h1>
                    <p>${error.message}</p>
                    <p>You need to serve this with proper CORS headers:</p>
                    <pre>Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Embedder-Policy: require-corp</pre>
                    <p>Use the provided server.js: <code>node server.js</code></p>
                </div>
            `;
        });
    </script>
</body>
</html>