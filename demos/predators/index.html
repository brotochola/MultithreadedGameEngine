<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Predators Demo - Multithreaded Game Engine</title>
    <style>
        body {
            margin: 0;
            /* overflow: hidden; */
            background: #111;
            font-family: monospace;
        }

        canvas {
            display: block;
            /* width: 800px;
            height: 600px; */
            border: 1px solid #333;
        }

        p {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            margin: 5px 10px;
        }

        #config {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }

        #spatialFPS {
            color: #a29bfe;
        }

        .logicFPS {
            color: #ff6b6b;
        }

        #physicsFPS {
            color: #4ecdc4;
        }

        #renderFPS {
            color: #ffe66d;
        }

        #visibleUnits {
            color: #95e1d3;
        }
    </style>
</head>
<body>
    <p id="config">Mode: SHARED ARRAY BUFFER (Multi-Worker) - Structure of Arrays + Spatial Hash</p>
    <p id="spatialFPS">Spatial Worker FPS: --</p>
    <div id="logicFPSContainer"></div>
    <p id="physicsFPS">Physics Worker FPS: --</p>
    <p id="rendererFPS">Renderer Worker FPS: --</p>
    <p id="numberBoids">Number of entities: --</p>
    <p id="visibleUnits">Visible units: --</p>
    <p id="activeUnits">Active units: --</p>
    <p id="poolStats" style="color: #95e1d3;">Pool Stats: --</p>
    <p id="mousePos" style="color: #999; font-size: 12px;">Mouse: --</p>
    <p>Move camera with WASD or Arrow Keys, mousewheel to zoom in and out</p>
    <p id="debugInfo" style="color: #00ff88; font-size: 12px;">
        Debug: Press [1] Colliders | [2] Velocity | [3] Accel | [4] Neighbors (hover entity!) | [5] Grid | [0] All Off
    </p>

    <div style="padding: 10px 0;">
        <button onclick="gameEngine.pause()">‚è∏Ô∏è Pause</button>
        <button onclick="gameEngine.resume()">‚ñ∂Ô∏è Resume</button>
        <button onclick="spawnRandomPrey()">‚ûï Spawn Prey</button>
        <button onclick="spawnRandomPredator()">‚ûï Spawn Predator</button>
        <button onclick="spawnPreyAtMouse()">üéØ Spawn Prey at Mouse</button>
        <button onclick="spawnPredatorAtMouse()">üéØ Spawn Predator at Mouse</button>
        <button onclick="clearAllEntities()" style="background: #ff6b6b;">üóëÔ∏è Clear All</button>
    </div>

    <div style="padding: 10px 0;">
        <button onclick="gameEngine.debug.showColliders(true)">üîµ Show Colliders</button>
        <button onclick="gameEngine.debug.showVelocity(true)">üîµ Show Velocity</button>
        <button onclick="gameEngine.debug.showAcceleration(true)">üî¥ Show Acceleration</button>
        <button onclick="gameEngine.debug.showNeighbors(true)">üîµ Show Neighbors</button>
        <button onclick="gameEngine.debug.showSpatialGrid(true)">‚¨ú Show Grid</button>
        <button onclick="gameEngine.debug.disableAll()" style="background: #ff6b6b;">‚ùå Debug Off</button>
    </div>

    <script type="module">
        const numberOfPrey = 15000;
        const numberOfPredators = 10;
        const numberOfBoids = 0;
        // Import engine classes and entity classes
        import { GameEngine } from '/src/core/gameEngine.js';
        import { Boid } from '/demos/predators/boid.js';
        import { Prey } from '/demos/predators/prey.js';
        import { Predator } from '/demos/predators/predator.js';
        import { SpriteSheetRegistry } from '/src/core/SpriteSheetRegistry.js';

        const gameEngine = new GameEngine(
            {
                canvasWidth: window.innerWidth * 0.9,
                canvasHeight: 600,
                worldWidth: 5800,
                worldHeight: 2600,

                // Spatial hash grid configuration
                spatial: {
                    cellSize: 100,  // Increased to match visual range (reduces grid overhead)
                    maxNeighbors: 450,  // CRITICAL: Reduced from 400 to prevent O(n¬≤) explosion
                    noLimitFPS: true,

                },

                // Logic configuration
                logic: {
                    noLimitFPS: false,
                    numberOfLogicWorkers: 3,
                    numberOfEntitiesPerJob: 250,
                },

                // Physics configuration
                physics: {
                    subStepCount: 1,
                    noLimitFPS: true,
                    maxCollisionPairs: 1000000,
                    boundaryElasticity: 0,
                    collisionResponseStrength: 0.9,
                    verletDamping: 0.99,
                    gravity: { x: 0, y: 0 }
                },
                renderer: {
                    noLimitFPS: false,
                    bg: "bg",
                    ySorting: true,
                }
            },
            {
                bg: "/demos/predators/img/fondo.jpg",
                bunny: "/demos/predators/img/bunny.png",
                spritesheets: {
                    person: {
                        json: "/demos/predators/img/person.json",
                        png: "/demos/predators/img/person.png"
                    },
                    personaje: {
                        json: "/demos/predators/img/personaje.json",
                        png: "/demos/predators/img/personaje.png"
                    },
                    lpc: {
                        json: "/demos/predators/img/lpc.json",
                        png: "/demos/predators/img/lpc.png"
                    },
                    civil1: {
                        json: "/demos/predators/img/civil1.json",
                        png: "/demos/predators/img/civil1.png"
                    }
                }
            }
        );

        // Register entity classes - script paths auto-detected via EntityClass.scriptUrl!
        gameEngine.registerEntityClass(Boid, numberOfBoids);
        gameEngine.registerEntityClass(Prey, numberOfPrey);
        gameEngine.registerEntityClass(Predator, numberOfPredators);

        // Make gameEngine global for button onclick handlers
        window.gameEngine = gameEngine;

        // Add helper functions to window for easy console access
        window.enableProfiling = (enabled = true) => gameEngine.enableProfiling(enabled);

        // Dynamically create FPS display elements for each logic worker
        const logicFPSContainer = document.getElementById('logicFPSContainer');
        const numberOfLogicWorkers = gameEngine.numberOfLogicWorkers;
        for (let i = 0; i < numberOfLogicWorkers; i++) {
            const p = document.createElement('p');
            p.id = `logic${i}FPS`;
            p.className = 'logicFPS';
            p.textContent = `Logic Worker ${i} FPS: --`;
            logicFPSContainer.appendChild(p);
        }

        // Update config display to show actual number of workers
        const totalWorkers = 3 + numberOfLogicWorkers; // spatial + physics + renderer + N logic workers
        document.getElementById('config').textContent =
            `Mode: SHARED ARRAY BUFFER (${totalWorkers} Workers: 1 Spatial + ${numberOfLogicWorkers} Logic + 1 Physics + 1 Renderer)`;


        // Spawning functions - using clean unified API
        window.spawnRandomPrey = function () {
            for (let i = 0; i < numberOfPrey; i++) {
                gameEngine.spawnEntity('Prey', {
                    x: Math.random() * gameEngine.config.worldWidth,
                    y: Math.random() * gameEngine.config.worldHeight,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.spawnBoids = function () {
            for (let i = 0; i < numberOfBoids; i++) {
                gameEngine.spawnEntity('Boid', {
                    x: Math.random() * gameEngine.config.worldWidth,
                    y: Math.random() * gameEngine.config.worldHeight,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.spawnRandomPredator = function () {
            gameEngine.spawnEntity('Predator', {
                x: Math.random() * gameEngine.config.worldWidth,
                y: Math.random() * gameEngine.config.worldHeight,
                vx: 0,
                vy: 0
            });
        };

        window.spawnPreyAtMouse = function () {
            if (gameEngine.mouse && gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Prey', {
                    x: gameEngine.mouse.x,
                    y: gameEngine.mouse.y,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.spawnPredatorAtMouse = function () {
            if (gameEngine.mouse && gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Predator', {
                    x: gameEngine.mouse.x,
                    y: gameEngine.mouse.y,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.clearAllEntities = function () {
            if (confirm('Clear all entities?')) {
                // Broadcast to all logic workers
                gameEngine.workers.logicWorkers.forEach((worker) => {
                    worker.postMessage({ msg: 'clearAll' });
                });
            }
        };

        // Update pool stats periodically
        setInterval(() => {
            const poolStatsEl = document.getElementById('poolStats');
            if (poolStatsEl) {
                const boidStats = gameEngine.getPoolStats(Boid);
                const preyStats = gameEngine.getPoolStats(Prey);
                const predStats = gameEngine.getPoolStats(Predator);

                poolStatsEl.textContent = `Pool: Boid ${boidStats.active}/${boidStats.total} | Prey ${preyStats.active}/${preyStats.total} | Predator ${predStats.active}/${predStats.total}`;
            }
        }, 500);

        // DEBUG: Helper to check registry status
        window.checkRegistry = function () {
            // console.log("=== SpriteSheet Registry Status ===");
            const sheets = SpriteSheetRegistry.getSpritesheetNames();
            // console.log(`Loaded spritesheets: ${sheets.join(", ")}`);

            sheets.forEach(sheetName => {
                const anims = SpriteSheetRegistry.getAnimationNames(sheetName);
                // console.log(`\n${sheetName}: ${anims.length} animations`);
                // console.log("First 10:", anims.slice(0, 10));
            });
        };

        // Setup debug keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.key === '1') {
                gameEngine.debug.showColliders(!gameEngine.debug.isEnabled(0));
            } else if (e.key === '2') {
                gameEngine.debug.showVelocity(!gameEngine.debug.isEnabled(1));
            } else if (e.key === '3') {
                gameEngine.debug.showAcceleration(!gameEngine.debug.isEnabled(2));
            } else if (e.key === '4') {
                gameEngine.debug.showNeighbors(!gameEngine.debug.isEnabled(3));
            } else if (e.key === '5') {
                gameEngine.debug.showSpatialGrid(!gameEngine.debug.isEnabled(4));
            } else if (e.key === '0') {
                gameEngine.debug.disableAll();
            }
        });

        // Initialize and start
        gameEngine.init().then(() => {
            // console.log("Game initialized. Spawning entities...");

            // Make debug API available in console
            window.debug = gameEngine.debug;
            // console.log("üí° Debug API: Use window.debug or gameEngine.debug");
            // console.log("   Try: debug.enableAIDebug() or debug.enablePhysicsDebug()");

            // DEBUG: Check registry after init
            checkRegistry();


            spawnBoids();
            // Spawn 100 prey
            // console.log("Spawning 100 prey...");
            // // for (let i = 0; i < 4000; i++) {
            spawnRandomPrey();
            // // }

            // // // Spawn 10 predators
            // // console.log("Spawning 10 predators...");
            for (let i = 0; i < numberOfPredators; i++) {
                spawnRandomPredator();
            }



            // console.log("Spawning complete!");
        }).catch(error => {
            document.body.innerHTML = `
                <div style="color: white; padding: 20px;">
                    <h1>Error initializing game!</h1>
                    <p>${error.message}</p>
                    <p>You need to serve this with proper CORS headers:</p>
                    <pre>Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Embedder-Policy: require-corp</pre>
                    <p>Use the provided server: <code>node server/node_server.js</code></p>
                </div>
            `;
        });
    </script>
</body>
</html>