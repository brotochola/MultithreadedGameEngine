<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Predators Demo - Multithreaded Game Engine</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
            font-family: monospace;
        }

        canvas {
            display: block;
            width: 800px;
            height: 600px;
            border: 1px solid #333;
        }

        p {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            margin: 5px 10px;
        }

        #config {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }

        #spatialFPS {
            color: #a29bfe;
        }

        #logicFPS {
            color: #ff6b6b;
        }

        #physicsFPS {
            color: #4ecdc4;
        }

        #renderFPS {
            color: #ffe66d;
        }

        #visibleUnits {
            color: #95e1d3;
        }
    </style>
</head>
<body>
    <p id="config">Mode: SHARED ARRAY BUFFER (4 Workers) - Structure of Arrays + Spatial Hash</p>
    <p id="spatialFPS">Spatial Worker FPS: --</p>
    <p id="logicFPS">Logic Worker FPS: --</p>
    <p id="physicsFPS">Physics Worker FPS: --</p>
    <p id="rendererFPS">Renderer Worker FPS: --</p>
    <p id="numberBoids">Number of entities: --</p>
    <p id="visibleUnits">Visible units: --</p>
    <p id="activeUnits">Active units: --</p>
    <p id="poolStats" style="color: #95e1d3;">Pool Stats: --</p>
    <p id="mousePos" style="color: #999; font-size: 12px;">Mouse: --</p>
    <p>Move camera with WASD or Arrow Keys, mousewheel to zoom in and out</p>

    <div style="padding: 10px 0;">
        <button onclick="gameEngine.pause()">‚è∏Ô∏è Pause</button>
        <button onclick="gameEngine.resume()">‚ñ∂Ô∏è Resume</button>
        <button onclick="spawnRandomPrey()">‚ûï Spawn Prey</button>
        <button onclick="spawnRandomPredator()">‚ûï Spawn Predator</button>
        <button onclick="spawnPreyAtMouse()">üéØ Spawn Prey at Mouse</button>
        <button onclick="spawnPredatorAtMouse()">üéØ Spawn Predator at Mouse</button>
        <button onclick="clearAllEntities()" style="background: #ff6b6b;">üóëÔ∏è Clear All</button>
    </div>

    <script type="module">
        // Import engine classes and entity classes
        import { GameEngine } from '/src/core/gameEngine.js';
        import { Boid } from '/demos/predators/boid.js';
        import { Prey } from '/demos/predators/prey.js';
        import { Predator } from '/demos/predators/predator.js';

        // Initialize with GameEngine using class registration system
        const gameEngine = new GameEngine(
            {
                canvasWidth: 800,
                canvasHeight: 600,
                worldWidth: 2800,
                worldHeight: 2600,

                // Spatial hash grid configuration
                spatial: {
                    cellSize: 50,
                    maxNeighbors: 400,
                    noLimitFPS: false
                },

                // Logic configuration
                logic: {
                    noLimitFPS: false
                },

                // Physics configuration
                physics: {
                    subStepCount: 2,
                    noLimitFPS: false,
                    maxCollisionPairs: 100000,
                    boundaryElasticity: 0,
                    collisionResponseStrength: 0.9,
                    verletDamping: 0.99,
                    gravity: { x: 0, y: 0 }
                }
            },
            {
                bunny: "/demos/predators/img/bunny.png",
                spritesheets: {
                    person: {
                        json: "/demos/predators/img/person.json",
                        png: "/demos/predators/img/person.png"
                    },
                    personaje: {
                        json: "/demos/predators/img/personaje.json",
                        png: "/demos/predators/img/personaje.png"
                    }
                }
            }
        );

        // Register entity classes with their script paths
        gameEngine.registerEntityClass(Boid, 0, "../../demos/predators/boid.js");
        gameEngine.registerEntityClass(Prey, 15000, "../../demos/predators/prey.js");
        gameEngine.registerEntityClass(Predator, 50, "../../demos/predators/predator.js");

        // Make gameEngine global for button onclick handlers
        window.gameEngine = gameEngine;

        // Spawning functions - FIXED to use component property notation
        window.spawnRandomPrey = function () {
            for (let i = 0; i < 10000; i++) {
                gameEngine.spawnEntity('Prey', {
                    'transform.x': Math.random() * gameEngine.config.worldWidth,
                    'transform.y': Math.random() * gameEngine.config.worldHeight,
                    'rigidBody.vx': 0,
                    'rigidBody.vy': 0
                });
            }
        };

        window.spawnRandomPredator = function () {
            gameEngine.spawnEntity('Predator', {
                'transform.x': Math.random() * gameEngine.config.worldWidth,
                'transform.y': Math.random() * gameEngine.config.worldHeight,
                'rigidBody.vx': 0,
                'rigidBody.vy': 0
            });
        };

        window.spawnPreyAtMouse = function () {
            if (gameEngine.mouse && gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Prey', {
                    'transform.x': gameEngine.mouse.x,
                    'transform.y': gameEngine.mouse.y,
                    'rigidBody.vx': 0,
                    'rigidBody.vy': 0
                });
            }
        };

        window.spawnPredatorAtMouse = function () {
            if (gameEngine.mouse && gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Predator', {
                    'transform.x': gameEngine.mouse.x,
                    'transform.y': gameEngine.mouse.y,
                    'rigidBody.vx': 0,
                    'rigidBody.vy': 0
                });
            }
        };

        window.clearAllEntities = function () {
            if (confirm('Clear all entities?')) {
                gameEngine.workers.logic.postMessage({ msg: 'clearAll' });
            }
        };

        // Update pool stats periodically
        setInterval(() => {
            const poolStatsEl = document.getElementById('poolStats');
            if (poolStatsEl) {
                const boidStats = gameEngine.getPoolStats(Boid);
                const preyStats = gameEngine.getPoolStats(Prey);
                const predStats = gameEngine.getPoolStats(Predator);

                poolStatsEl.textContent = `Pool: Boid ${boidStats.active}/${boidStats.total} | Prey ${preyStats.active}/${preyStats.total} | Predator ${predStats.active}/${predStats.total}`;
            }
        }, 500);

        // Initialize and start
        gameEngine.init().then(() => {
            console.log("Game initialized. Spawning entities...");

            // Spawn 100 prey
            console.log("Spawning 100 prey...");
            // for (let i = 0; i < 4000; i++) {
            spawnRandomPrey();
            // }

            // // Spawn 10 predators
            // console.log("Spawning 10 predators...");
            for (let i = 0; i < 10; i++) {
                spawnRandomPredator();
            }

            console.log("Spawning complete!");
        }).catch(error => {
            document.body.innerHTML = `
                <div style="color: white; padding: 20px;">
                    <h1>Error initializing game!</h1>
                    <p>${error.message}</p>
                    <p>You need to serve this with proper CORS headers:</p>
                    <pre>Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Embedder-Policy: require-corp</pre>
                    <p>Use the provided server: <code>node server/node_server.js</code></p>
                </div>
            `;
        });
    </script>
</body>
</html>