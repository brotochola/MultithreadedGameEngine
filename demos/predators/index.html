<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Predators Demo - Multithreaded Game Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
        }

        /* Overlay Panels */
        .overlay-panel {
            position: fixed;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            color: white;
            font-size: 13px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s ease, opacity 0.3s ease;
            z-index: 1000;
        }

        .overlay-panel.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px);
        }

        /* Stats Panel */
        #statsPanel {
            top: 20px;
            left: 20px;
            max-width: 400px;
        }

        #statsPanel p {
            margin: 5px 0;
            line-height: 1.6;
        }

        /* Debug Controls Panel */
        #debugPanel {
            top: 20px;
            right: 20px;
            max-width: 300px;
        }

        /* Control Buttons Panel */
        #controlsPanel {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90vw;
        }

        #controlsPanel.hidden {
            transform: translateX(-50%) translateY(10px);
        }

        /* Toggle Buttons */
        .toggle-btn {
            position: fixed;
            z-index: 1001;
            background: rgba(76, 175, 80, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: rgba(76, 175, 80, 1);
            transform: scale(1.1);
        }

        #toggleStats {
            top: 20px;
            left: 20px;
        }

        #toggleDebug {
            top: 20px;
            right: 20px;
        }

        #toggleControls {
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            padding: 10px 20px;
            border-radius: 20px;
        }

        /* Action Buttons */
        button {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        button:active {
            transform: scale(0.95);
        }

        /* Color coding for different stats */
        #config {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        #spatialFPS {
            color: #a29bfe;
        }

        .logicFPS {
            color: #ff6b6b;
        }

        #physicsFPS {
            color: #4ecdc4;
        }

        #rendererFPS {
            color: #ffe66d;
        }

        #visibleUnits,
        #poolStats {
            color: #95e1d3;
        }

        #mousePos,
        #debugInfo {
            color: #999;
            font-size: 11px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .button-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Branding */
        #branding {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 24px;
            font-weight: bold;
            color: rgba(76, 175, 80, 0.3);
            letter-spacing: 4px;
            z-index: 999;
            text-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
        }
    </style>
</head>
<body>
    <!-- Branding -->
    <!-- <div id="branding">WEEDJS üåø</div> -->

    <!-- Toggle Buttons -->
    <button class="toggle-btn" id="toggleStats" onclick="togglePanel('statsPanel')" title="Toggle Stats">üìä</button>
    <button class="toggle-btn" id="toggleDebug" onclick="togglePanel('debugPanel')" title="Toggle Debug">üîß</button>
    <button class="toggle-btn" id="toggleControls" onclick="togglePanel('controlsPanel')" title="Toggle Controls">‚öôÔ∏è
        Controls</button>

    <!-- Stats Panel -->
    <div class="overlay-panel" id="statsPanel">
        <div class="panel-title">‚ö° Performance Stats</div>
        <p id="config">Mode: SHARED ARRAY BUFFER (Multi-Worker) - Structure of Arrays + Spatial Hash</p>
        <p id="spatialFPS">Spatial Worker FPS: --</p>
        <div id="logicFPSContainer"></div>
        <p id="physicsFPS">Physics Worker FPS: --</p>
        <p id="rendererFPS">Renderer Worker FPS: --</p>
        <p id="numberBoids">Number of entities: --</p>
        <p id="visibleUnits">Visible units: --</p>
        <p id="activeUnits">Active units: --</p>
        <p id="poolStats">Pool Stats: --</p>
        <p id="mousePos">Mouse: --</p>
        <p
            style="color: #666; font-size: 11px; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
            üéÆ WASD or Arrow Keys to move | Mousewheel to zoom
        </p>
    </div>

    <!-- Debug Panel -->
    <div class="overlay-panel" id="debugPanel">
        <div class="panel-title">üîß Debug Tools</div>
        <p id="debugInfo">
            Keyboard Shortcuts:<br>
            [1] Colliders | [2] Velocity | [3] Accel<br>
            [4] Neighbors | [5] Grid | [0] All Off<br>
            [H] Hide/Show All Panels
        </p>
        <div class="button-group">
            <button onclick="gameEngine.debug.showColliders(true)">üîµ Show Colliders</button>
            <button onclick="gameEngine.debug.showVelocity(true)">üîµ Show Velocity</button>
            <button onclick="gameEngine.debug.showAcceleration(true)">üî¥ Show Acceleration</button>
            <button onclick="gameEngine.debug.showNeighbors(true)">üîµ Show Neighbors</button>
            <button onclick="gameEngine.debug.showSpatialGrid(true)">‚¨ú Show Grid</button>
            <button onclick="gameEngine.debug.disableAll()" style="background: rgba(255, 107, 107, 0.3);">‚ùå Debug
                Off</button>
        </div>
    </div>

    <!-- Controls Panel -->
    <div class="overlay-panel" id="controlsPanel">
        <div class="button-row">
            <button onclick="gameEngine.pause()">‚è∏Ô∏è Pause</button>
            <button onclick="gameEngine.resume()">‚ñ∂Ô∏è Resume</button>
            <button onclick="spawnRandomPrey()">‚ûï Spawn Prey</button>
            <button onclick="spawnRandomPredator()">‚ûï Spawn Predator</button>
            <button onclick="spawnPreyAtMouse()">üéØ Prey at Mouse</button>
            <button onclick="spawnPredatorAtMouse()">üéØ Predator at Mouse</button>
            <button onclick="clearAllEntities()" style="background: rgba(255, 107, 107, 0.3);">üóëÔ∏è Clear All</button>
        </div>
    </div>

    <script type="module">
        const numberOfPrey = 29990;
        const numberOfPredators = 10;
        const numberOfBoids = 0;
        // Import WeedJS engine üåø
        import WEED from '/src/index.js';
        import { Boid } from '/demos/predators/boid.js';
        import { Prey } from '/demos/predators/prey.js';
        import { Predator } from '/demos/predators/predator.js';

        // Destructure what we need from WEED
        const { GameEngine, SpriteSheetRegistry } = WEED;

        // Panel toggle functionality
        window.togglePanel = function (panelId) {
            const panel = document.getElementById(panelId);
            panel.classList.toggle('hidden');
        };

        const gameEngine = new GameEngine(
            {
                canvasWidth: window.innerWidth,
                canvasHeight: window.innerHeight,
                worldWidth: 5000,
                worldHeight: 2500,
                seed: 123456,

                // Spatial hash grid configuration
                spatial: {
                    cellSize: 100,  // Increased to match visual range (reduces grid overhead)
                    maxNeighbors: 450,  // CRITICAL: Reduced from 400 to prevent O(n¬≤) explosion
                    noLimitFPS: true,

                },

                // Logic configuration
                logic: {
                    noLimitFPS: false,
                    numberOfLogicWorkers: 3,
                    numberOfEntitiesPerJob: 250,
                },

                // Physics configuration
                physics: {
                    subStepCount: 1,
                    noLimitFPS: true,
                    maxCollisionPairs: 1000000,
                    boundaryElasticity: 0,
                    collisionResponseStrength: 0.9,
                    verletDamping: 0.99,
                    gravity: { x: 0, y: 0 }
                },
                renderer: {
                    noLimitFPS: false,
                    // bg: "bg",
                    ySorting: true,
                }
            },
            {
                bg: "/demos/predators/img/bg.png",
                bunny: "/demos/predators/img/bunny.png",
                spritesheets: {
                    civil1: {
                        json: "/demos/predators/img/civil1.json",
                        png: "/demos/predators/img/civil1.png"
                    },
                    civil2: {
                        json: "/demos/predators/img/civil2.json",
                        png: "/demos/predators/img/civil2.png"
                    },
                    civil3: {
                        json: "/demos/predators/img/civil3.json",
                        png: "/demos/predators/img/civil3.png"
                    },
                    civil4: {
                        json: "/demos/predators/img/civil4.json",
                        png: "/demos/predators/img/civil4.png"
                    },
                    civil5: {
                        json: "/demos/predators/img/civil5.json",
                        png: "/demos/predators/img/civil5.png"
                    },
                    civil6: {
                        json: "/demos/predators/img/civil6.json",
                        png: "/demos/predators/img/civil6.png"
                    },
                    civil7: {
                        json: "/demos/predators/img/civil7.json",
                        png: "/demos/predators/img/civil7.png"
                    }
                }
            }
        );

        // Register entity classes - script paths auto-detected via EntityClass.scriptUrl!
        gameEngine.registerEntityClass(Boid, numberOfBoids);
        gameEngine.registerEntityClass(Prey, numberOfPrey);
        gameEngine.registerEntityClass(Predator, numberOfPredators);

        // Make gameEngine global for button onclick handlers
        window.gameEngine = gameEngine;

        // Add helper functions to window for easy console access
        window.enableProfiling = (enabled = true) => gameEngine.enableProfiling(enabled);

        // Dynamically create FPS display elements for each logic worker
        const logicFPSContainer = document.getElementById('logicFPSContainer');
        const numberOfLogicWorkers = gameEngine.numberOfLogicWorkers;
        for (let i = 0; i < numberOfLogicWorkers; i++) {
            const p = document.createElement('p');
            p.id = `logic${i}FPS`;
            p.className = 'logicFPS';
            p.textContent = `Logic Worker ${i} FPS: --`;
            logicFPSContainer.appendChild(p);
        }

        // Update config display to show actual number of workers
        const totalWorkers = 3 + numberOfLogicWorkers; // spatial + physics + renderer + N logic workers
        document.getElementById('config').textContent =
            `Mode: SHARED ARRAY BUFFER (${totalWorkers} Workers: 1 Spatial + ${numberOfLogicWorkers} Logic + 1 Physics + 1 Renderer)`;


        // Spawning functions - using clean unified API
        window.spawnRandomPrey = function () {
            for (let i = 0; i < numberOfPrey; i++) {
                gameEngine.spawnEntity('Prey', {
                    x: gameEngine.rng() * gameEngine.config.worldWidth,
                    y: gameEngine.rng() * gameEngine.config.worldHeight,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.spawnBoids = function () {
            for (let i = 0; i < numberOfBoids; i++) {
                gameEngine.spawnEntity('Boid', {
                    x: gameEngine.rng() * gameEngine.config.worldWidth,
                    y: gameEngine.rng() * gameEngine.config.worldHeight,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.spawnRandomPredator = function () {
            for (let i = 0; i < numberOfPredators; i++) {
                gameEngine.spawnEntity('Predator', {
                    x: gameEngine.rng() * gameEngine.config.worldWidth,
                    y: gameEngine.rng() * gameEngine.config.worldHeight,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.spawnPreyAtMouse = function () {
            if (gameEngine.mouse && gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Prey', {
                    x: gameEngine.mouse.x,
                    y: gameEngine.mouse.y,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.spawnPredatorAtMouse = function () {
            if (gameEngine.mouse && gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Predator', {
                    x: gameEngine.mouse.x,
                    y: gameEngine.mouse.y,
                    vx: 0,
                    vy: 0
                });
            }
        };

        window.clearAllEntities = function () {
            if (confirm('Clear all entities?')) {
                // Broadcast to all logic workers
                gameEngine.workers.logicWorkers.forEach((worker) => {
                    worker.postMessage({ msg: 'clearAll' });
                });
            }
        };

        // Update pool stats periodically
        setInterval(() => {
            const poolStatsEl = document.getElementById('poolStats');
            if (poolStatsEl) {
                const boidStats = gameEngine.getPoolStats(Boid);
                const preyStats = gameEngine.getPoolStats(Prey);
                const predStats = gameEngine.getPoolStats(Predator);

                poolStatsEl.textContent = `Pool: Boid ${boidStats.active}/${boidStats.total} | Prey ${preyStats.active}/${preyStats.total} | Predator ${predStats.active}/${predStats.total}`;
            }
        }, 500);

        // DEBUG: Helper to check registry status
        window.checkRegistry = function () {
            // console.log("=== SpriteSheet Registry Status ===");
            const sheets = SpriteSheetRegistry.getSpritesheetNames();
            // console.log(`Loaded spritesheets: ${sheets.join(", ")}`);

            sheets.forEach(sheetName => {
                const anims = SpriteSheetRegistry.getAnimationNames(sheetName);
                // console.log(`\n${sheetName}: ${anims.length} animations`);
                // console.log("First 10:", anims.slice(0, 10));
            });
        };

        // Toggle all panels with H key
        window.toggleAllPanels = function () {
            const panels = ['statsPanel', 'debugPanel', 'controlsPanel'];
            panels.forEach(panelId => {
                document.getElementById(panelId).classList.toggle('hidden');
            });
        };

        // Setup debug keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.key === '1') {
                gameEngine.debug.showColliders(!gameEngine.debug.isEnabled(0));
            } else if (e.key === '2') {
                gameEngine.debug.showVelocity(!gameEngine.debug.isEnabled(1));
            } else if (e.key === '3') {
                gameEngine.debug.showAcceleration(!gameEngine.debug.isEnabled(2));
            } else if (e.key === '4') {
                gameEngine.debug.showNeighbors(!gameEngine.debug.isEnabled(3));
            } else if (e.key === '5') {
                gameEngine.debug.showSpatialGrid(!gameEngine.debug.isEnabled(4));
            } else if (e.key === '0') {
                gameEngine.debug.disableAll();
            } else if (e.key === 'h' || e.key === 'H') {
                toggleAllPanels();
            }
        });

        // Initialize and start
        gameEngine.init().then(() => {
            // console.log("Game initialized. Spawning entities...");

            // Make debug API available in console
            window.debug = gameEngine.debug;
            // console.log("üí° Debug API: Use window.debug or gameEngine.debug");
            // console.log("   Try: debug.enableAIDebug() or debug.enablePhysicsDebug()");

            // DEBUG: Check registry after init
            checkRegistry();

            for (let i = 0; i < numberOfPredators; i++) {
                spawnRandomPredator();
            }

            spawnBoids();

            spawnRandomPrey();






            // console.log("Spawning complete!");
        }).catch(error => {
            document.body.innerHTML = `
                <div style="color: white; padding: 20px;">
                    <h1>Error initializing game!</h1>
                    <p>${error.message}</p>
                    <p>You need to serve this with proper CORS headers:</p>
                    <pre>Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Embedder-Policy: require-corp</pre>
                    <p>Use the provided server: <code>node server/node_server.js</code></p>
                </div>
            `;
        });
    </script>
</body>
</html>