<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Balls Game - Gravity and Separation Demo</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #111;
            font-family: monospace;
        }

        canvas {
            display: block;
            /* width: 800px;
            height: 600px; */
            border: 1px solid #333;
        }

        p {
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            margin: 5px 10px;
        }

        #config {
            color: #4CAF50;
            font-weight: bold;
            font-size: 18px;
        }

        #spatialFPS {
            color: #a29bfe;
        }

        #logicFPS {
            color: #ff6b6b;
        }

        #physicsFPS {
            color: #4ecdc4;
        }

        #renderFPS {
            color: #ffe66d;
        }

        #visibleUnits {
            color: #95e1d3;
        }
    </style>
</head>
<body>
    <p id="config">Balls Game - Gravity & Separation Physics Demo</p>
    <p id="spatialFPS">Spatial Worker FPS: --</p>
    <p id="logicFPS">Logic Worker FPS: --</p>
    <p id="physicsFPS">Physics Worker FPS: --</p>
    <p id="rendererFPS">Renderer Worker FPS: --</p>
    <p id="numberBoids">Number of entities: --</p>
    <p id="visibleUnits">Visible units: --</p>
    <p id="activeUnits">Active units: --</p>
    <p id="poolStats" style="color: #95e1d3;">Pool Stats: --</p>
    <p id="mousePos" style="color: #999; font-size: 12px;">Mouse: --</p>
    <p>Move camera with WASD or Arrow Keys, mousewheel to zoom in and out</p>
    <p id="debugInfo" style="color: #00ff88; font-size: 12px;">
        Debug: Press [1] Colliders | [2] Velocity | [3] Accel | [4] Neighbors (hover entity!) | [5] Grid | [0] All Off
    </p>

    <div style="padding: 10px 0;">
        <button onclick="gameEngine.pause()">‚è∏Ô∏è Pause</button>
        <button onclick="gameEngine.resume()">‚ñ∂Ô∏è Resume</button>
        <button onclick="spawnRandomBall()">‚ûï Spawn Ball</button>
        <button onclick="spawnBallAtMouse()">üéØ Spawn Ball at Mouse</button>
        <button onclick="spawnMultipleBalls()">‚ûï‚ûï Spawn 10 Balls</button>
        <button onclick="clearAllEntities()" style="background: #ff6b6b;">üóëÔ∏è Clear All</button>
    </div>

    <div style="padding: 10px 0;">
        <button onclick="gameEngine.debug.showColliders(true)">üîµ Show Colliders</button>
        <button onclick="gameEngine.debug.showVelocity(true)">üîµ Show Velocity</button>
        <button onclick="gameEngine.debug.showAcceleration(true)">üî¥ Show Acceleration</button>
        <button onclick="gameEngine.debug.showNeighbors(true)">üîµ Show Neighbors</button>
        <button onclick="gameEngine.debug.showSpatialGrid(true)">‚¨ú Show Grid</button>
        <button onclick="gameEngine.debug.disableAll()" style="background: #ff6b6b;">‚ùå Debug Off</button>
    </div>

    <script type="module">
        // Import engine classes
        import { GameEngine } from '/src/core/gameEngine.js';
        import { Ball } from '/demos/balls/ball.js';

        const numOfBalls = 10000;

        // Initialize with GameEngine using class registration system
        const gameEngine = new GameEngine(
            {
                canvasWidth: window.innerWidth * 0.9,
                canvasHeight: 600,
                worldWidth: 9000,
                worldHeight: 4000,

                // Spatial hash grid configuration
                spatial: {
                    cellSize: 50,        // Each cell size in world units
                    maxNeighbors: 900,   // Maximum neighbors to track per entity
                    noLimitFPS: true    // If true, runs as fast as possible instead of 60fps
                },

                // Logic configuration
                logic: {
                    noLimitFPS: false,    // If true, runs as fast as possible instead of 60fps
                },

                // Physics configuration
                physics: {
                    subStepCount: 2,     // Constraint solver iterations per frame (4-8 recommended)
                    noLimitFPS: true,   // If true, runs as fast as possible instead of 60fps

                    // Collision Detection
                    maxCollisionPairs: 0, // Maximum collision pairs per frame
                    verletDamping: 0.99,
                    boundaryElasticity: 0,
                    collisionResponseStrength: 0.8,
                    // Global Forces
                    gravity: { x: 0, y: 0.5 }   // Global gravity (lower = more stable stacking)
                }, renderer: {
                    noLimitFPS: false,
                }
            },
            {
                // Simple textures
                ball: "/demos/balls/bola.png",
                // bg: "/demos/predators/img/fondo.jpg",
            }
        );

        window.gameEngine = gameEngine

        // Register entity classes - script path auto-detected via Ball.scriptUrl!
        gameEngine.registerEntityClass(Ball, numOfBalls);

        // Spawning functions
        function spawnRandomBall() {
            gameEngine.spawnEntity('Ball', {
                x: Math.random() * gameEngine.config.worldWidth,
                y: Math.random() * gameEngine.config.worldHeight,
                vx: 0,//(Math.random() - 0.5) * 5, // Random horizontal velocity
                vy: 0 // Start with no vertical velocity
            });
        }

        function spawnBallAtMouse() {
            if (gameEngine.mouse.x > 0 && gameEngine.mouse.y > 0) {
                gameEngine.spawnEntity('Ball', {
                    x: gameEngine.mouse.x,
                    y: gameEngine.mouse.y,
                    vx: 0,
                    vy: 0
                });
            }
        }

        function spawnMultipleBalls() {
            for (let i = 0; i < 10; i++) {
                setTimeout(() => {
                    spawnRandomBall();
                }, i * 50); // Stagger spawning slightly
            }
        }

        function clearAllEntities() {
            if (confirm('Clear all balls?')) {
                gameEngine.workers.logic.postMessage({ msg: 'clearAll' });
            }
        }

        // Update pool stats periodically
        setInterval(() => {
            const poolStatsEl = document.getElementById('poolStats');
            if (poolStatsEl) {
                const ballStats = gameEngine.getPoolStats(Ball);
                poolStatsEl.textContent = `Pool: Ball ${ballStats.active}/${ballStats.total}`;
            }
        }, 500);

        // Setup debug keyboard shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.key === '1') {
                gameEngine.debug.showColliders(!gameEngine.debug.isEnabled(0));
            } else if (e.key === '2') {
                gameEngine.debug.showVelocity(!gameEngine.debug.isEnabled(1));
            } else if (e.key === '3') {
                gameEngine.debug.showAcceleration(!gameEngine.debug.isEnabled(2));
            } else if (e.key === '4') {
                gameEngine.debug.showNeighbors(!gameEngine.debug.isEnabled(3));
            } else if (e.key === '5') {
                gameEngine.debug.showSpatialGrid(!gameEngine.debug.isEnabled(4));
            } else if (e.key === '0') {
                gameEngine.debug.disableAll();
            }
        });

        // Initialize and start
        gameEngine.init().then(() => {
            console.log("Game initialized. Spawning balls...");

            // Make debug API available in console
            window.debug = gameEngine.debug;
            console.log("üí° Debug API: Use window.debug or gameEngine.debug");
            console.log("   Try: debug.enablePhysicsDebug()");

            // Spawn balls
            for (let i = 0; i < numOfBalls; i++) {
                spawnRandomBall();
            }
        }).catch(error => {
            document.body.innerHTML = `
                <div style="color: white; padding: 20px;">
                    <h1>Error initializing game!</h1>
                    <p>${error.message}</p>
                    <p>You need to serve this with proper CORS headers:</p>
                    <pre>Cross-Origin-Opener-Policy: same-origin
Cross-Origin-Embedder-Policy: require-corp</pre>
                    <p>Use the provided server.js: <code>node server.js</code></p>
                </div>
            `;
        });
    </script>
</body>
</html>